name: üçé macOS Build

on:
  workflow_call:
    inputs:
      tag:
        description: 'Git tag for release builds.'
        required: false
        type: string

  # Triggers on tag pushes (for direct releases)
  push:
    tags:
      - 'v*'

jobs:
  build-macos:
    name: üçé Build and Deploy macOS via codemagic
    runs-on: ubuntu-latest
    env:
      MACOS_CODEMAGIC_HOOK_URL: ${{ secrets.MACOS_CODEMAGIC_HOOK_URL }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      - name: DEBUG Print Workflow Input Tag
        run: |
          echo "Workflow Input (inputs.tag): ${{ inputs.tag }}"
          echo "GitHub ref: ${{ github.ref }}"
          echo "GitHub ref name: ${{ github.ref_name }}"
        shell: bash

      - name: Determine Build Context & Variables
        id: vars
        uses: ./.github/actions/determine_build_vars
        with:
          platform: 'macos'
          event_name: ${{ github.event_name }}
          tag_input: ${{ inputs.tag || github.ref_name }}
          pr_number: ${{ github.event.number }}
          run_id: ${{ github.run_id }}

      - name: Trigger Codemagic Build
        if: steps.vars.outputs.build_type == 'release'
        run: |
          # Make a post request to the codemagic.io webhook
          curl -X POST -H "Content-Type: application/json" -d '{"tag": "${{ inputs.tag || github.ref_name }}"}' ${{ env.MACOS_CODEMAGIC_HOOK_URL }}
        shell: bash

      # Note: Codemagic will handle the actual build and should upload artifacts
      # that can be downloaded by the release workflow. This is a placeholder
      # until Codemagic integration is fully configured.
      - name: Create Placeholder macOS Artifact
        if: steps.vars.outputs.build_type == 'release'
        run: |
          echo "macOS build triggered via Codemagic for tag: ${{ inputs.tag || github.ref_name }}"
          echo "This is a placeholder until Codemagic integration is complete"
          touch placeholder-macos-build.txt
        shell: bash

      - name: Upload Placeholder Artifact
        if: steps.vars.outputs.build_type == 'release'
        uses: actions/upload-artifact@v4
        with:
          name: ${{ steps.vars.outputs.artifact_upload_name }}
          path: placeholder-macos-build.txt
